<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‹•ç‰©é»æ“Šç«¶è³½</title>
  <style>
    body {
    /* å¤ªé™½å‹•ç•« */
    .sun {
      position: absolute;
      top: 3vh;
      right: 6vw;
      width: 80px;
      height: 80px;
      z-index: 10;
      border-radius: 50%;
      background: radial-gradient(circle at 60% 40%, #fffde4 30%, #ffe082 70%, #ffd600 100%);
      box-shadow: 0 0 40px 10px #ffe08299, 0 0 0 #fff0;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: sun-rotate 8s linear infinite;
      overflow: visible;
    }
    @keyframes sun-rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sun-face {
      position: absolute;
      left: 0; top: 0;
      width: 80px; height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11;
    }
    .sun-smile {
      /* position: absolute;
      left: 22px; top: 38px;
      width: 36px; height: 18px;
      border-bottom: 4px solid #fbc02d;
      border-radius: 0 0 36px 36px; */

       position: absolute;
       left: 22px; top: 43px;
        width: 39px;
        height: 13px;
        border-bottom: 4px solid #fbc02d;
        border-radius: 0 0 30px 30px;
        transform: rotate(-10deg);
    }
    .sun-eye {
      position: absolute;
      width: 8px; height: 8px;
      background: #fbc02d;
      border-radius: 50%;
      top: 28px;
    }
    .sun-eye.left { left: 28px; }
    .sun-eye.right { left: 44px; }

    .sunglasses {
        position: absolute;
        top: 55px;
        left: 35px;
        width: 110px;
        height: 30px;
        background: black;
        border-radius: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 5px;
        animation: liftFromLeft 4s infinite ease-in-out;
      }
      .lens {
        width: 45px;
        height: 25px;
        background: #333;
        border-radius: 8px;
      }
    .sun-ray {
      position: absolute;
      width: 16px; height: 4px;
      background: linear-gradient(90deg, #ffd600 60%, #fffde4 100%);
      border-radius: 2px;
      top: 38px; left: 32px;
      transform-origin: 8px 42px;
      opacity: 0.7;
    }

   
    /* 12é“å…‰èŠ’ */
    .sun-ray.r0 { transform: rotate(0deg) translateY(-44px); }
    .sun-ray.r1 { transform: rotate(30deg) translateY(-44px); }
    .sun-ray.r2 { transform: rotate(60deg) translateY(-44px); }
    .sun-ray.r3 { transform: rotate(90deg) translateY(-44px); }
    .sun-ray.r4 { transform: rotate(120deg) translateY(-44px); }
    .sun-ray.r5 { transform: rotate(150deg) translateY(-44px); }
    .sun-ray.r6 { transform: rotate(180deg) translateY(-44px); }
    .sun-ray.r7 { transform: rotate(210deg) translateY(-44px); }
    .sun-ray.r8 { transform: rotate(240deg) translateY(-44px); }
    .sun-ray.r9 { transform: rotate(270deg) translateY(-44px); }
    .sun-ray.r10 { transform: rotate(300deg) translateY(-44px); }
    .sun-ray.r11 { transform: rotate(330deg) translateY(-44px); }
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      background: linear-gradient(120deg, #fceabb 0%, #f8b500 40%, #fceabb 100%);
      margin: 0;
      padding: 2rem;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    /* æ¨‚åœ’é›²æœµ */
    .cloud {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      opacity: 0.85;
      box-shadow:
        60px 0px 0px 0px #fff,
        120px 10px 0px 0px #fff,
        30px 20px 0px 0px #fff,
        90px 25px 0px 0px #fff;
      width: 100px;
      height: 60px;
      z-index: 0;
      animation: cloudMove 40s linear infinite;
    }
    .cloud2 {
      width: 70px;
      height: 40px;
      left: 60vw;
      top: 12vh;
      opacity: 0.7;
      animation-duration: 55s;
    }
    .cloud3 {
      width: 120px;
      height: 70px;
      left: 20vw;
      top: 18vh;
      opacity: 0.6;
      animation-duration: 70s;
    }
    @keyframes cloudMove {
      0% { left: -150px; }
      100% { left: 110vw; }
    }
    /* æ¨‚åœ’å½©çƒ */
    .balloon {
      position: absolute;
      width: 38px;
      height: 48px;
      background: radial-gradient(circle at 60% 30%, #fff 10%, #ffb347 60%, #ffcc80 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      box-shadow: 0 6px 18px #ffb34755;
      z-index: 1;
      animation: balloonFloat 7s ease-in-out infinite alternate;
    }
    .balloon2 {
      left: 80vw;
      top: 30vh;
      background: radial-gradient(circle at 60% 30%, #fff 10%, #81d4fa 60%, #b3e5fc 100%);
      animation-delay: 2s;
    }
    .balloon3 {
      left: 10vw;
      top: 35vh;
      background: radial-gradient(circle at 60% 30%, #fff 10%, #e57373 60%, #ffcdd2 100%);
      animation-delay: 3.5s;
    }

     @keyframes liftFromLeft {
      0%   { transform: rotate(0deg); }
      25%  { transform: rotate(-25deg); }
      50%  { transform: rotate(0deg); }
      75%  { transform: rotate(-25deg); }
      100% { transform: rotate(0deg); }
    }
    
    @keyframes balloonFloat {
      0% { transform: translateY(0) scale(1); }
      100% { transform: translateY(-40px) scale(1.07); }
    }
    /* æ¨‚åœ’è‰åœ° */
    .grass {
      position: fixed;
      left: 0; bottom: 0;
      width: 100vw;
      height: 120px;
      background: linear-gradient(0deg, #388e3c 80%, #81c784 100%);
      z-index: 2;
      box-shadow: 0 -8px 32px #388e3c44;
      overflow: visible;
    }
    .grass-decoration {
      position: fixed;
      left: 0; bottom: 0;
      width: 100vw;
      height: 120px;
      pointer-events: none;
      z-index: 3;
    }
    /* è‰å¢ */
    .bush {
      position: absolute;
      bottom: 18px;
      width: 60px;
      height: 32px;
      background: radial-gradient(circle at 60% 60%, #66bb6a 60%, #388e3c 100%);
      border-radius: 50% 50% 50% 50% / 70% 70% 60% 60%;
      box-shadow: -18px 0 0 0 #81c784, 18px 0 0 0 #81c784;
    }
    .bush2 {
      left: 18vw;
      width: 38px;
      height: 20px;
      background: radial-gradient(circle at 60% 60%, #a5d6a7 60%, #388e3c 100%);
      box-shadow: -10px 0 0 0 #81c784, 10px 0 0 0 #81c784;
    }
    .bush3 {
      left: 70vw;
      width: 48px;
      height: 26px;
      background: radial-gradient(circle at 60% 60%, #43a047 60%, #388e3c 100%);
      box-shadow: -14px 0 0 0 #81c784, 14px 0 0 0 #81c784;
    }
    /* å°èŠ± */
    .flower {
      position: absolute;
      width: 12px;
      height: 12px;
      background: radial-gradient(circle, #fff176 60%, #f06292 100%);
      border-radius: 50%;
      box-shadow: 8px 0 #fff176, -8px 0 #fff176, 0 8px #fff176, 0 -8px #fff176;
      /* ä½ç½®ç”± style å‹•æ…‹æ§åˆ¶ */
    }
    .flower2 {
      left: 80vw;
      background: radial-gradient(circle, #fff176 60%, #4fc3f7 100%);
    }
    /* å°æ¨¹ */
    .tree {
      position: absolute;
      width: 12px;
      height: 36px;
      background: #8d6e63;
      border-radius: 4px;
    }
    .tree::after {
      content: '';
      position: absolute;
      left: -10px; top: -22px;
      width: 32px; height: 32px;
      background: radial-gradient(circle at 60% 60%, #388e3c 60%, #81c784 100%);
      border-radius: 50%;
      z-index: 1;
    }

    h1 {
      color: #333;
    }

    .animal-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1.5rem 0;
    }

    .animal {
      font-size: 5rem;
      transition: transform 0.2s ease;
    }

    .bounce {
      transform: scale(1.3);
    }

    button {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      margin-top: 0.5rem;
      border: none;
      border-radius: 8px;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    .counter {
      font-size: 1.2rem;
      margin-top: 0.3rem;
    }

    #winner {
      font-size: 2rem;
      margin-top: 2rem;
      color: #d2691e;
    }

    #countdown {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <!-- å‹•æ…‹å¤ªé™½ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <!-- <div class="sun">
    <div class="sun-face">
      <div class="sunglasses">
        <div class="lens"></div>
        <div class="lens"></div>
      </div>
      <div class="sun-eye left"></div>
      <div class="sun-eye right"></div>
      <div class="sun-smile"></div>
    </div>
    <div class="sun-ray r0"></div>
    <div class="sun-ray r1"></div>
    <div class="sun-ray r2"></div>
    <div class="sun-ray r3"></div>
    <div class="sun-ray r4"></div>
    <div class="sun-ray r5"></div>
    <div class="sun-ray r6"></div>
    <div class="sun-ray r7"></div>
    <div class="sun-ray r8"></div>
    <div class="sun-ray r9"></div>
    <div class="sun-ray r10"></div>
    <div class="sun-ray r11"></div>
  </div> -->
  <!-- æ¨‚åœ’é›²æœµèˆ‡å½©çƒ -->
  <div class="cloud" style="top:8vh;left:5vw;"></div>
  <div class="cloud cloud2"></div>
  <div class="cloud cloud3"></div>
  <div class="balloon" style="left: 15vw; top: 28vh;"></div>
  <div class="balloon balloon2"></div>
  <div class="balloon balloon3"></div>
  <h1 onclick="verifyArea()">ğŸ¾ å‹•ç‰©é»æ“Šç«¶è³½ ğŸ¾</h1>
  <div id="countdown">ç­‰å¾…é–‹å§‹...</div>
  <div id="selectScreen">
    <h2>è«‹é¸æ“‡ä½ çš„å‹•ç‰©è§’è‰²</h2>
    <button id="btn-rabbit" onclick="selectAnimal('rabbit')">ğŸ° å…”å­</button>
    <button id="btn-turtle" onclick="selectAnimal('turtle')">ğŸ¢ çƒé¾œ</button>
    <button id="btn-monkey" onclick="selectAnimal('monkey')">ğŸ’ çŒ´å­</button>
  </div>


  <!-- éŠæˆ²ç•«é¢ -->
  <div id="gameScreen" style="display: none;">
    <h3>ç›®å‰é»æ“Šæ¬¡æ•¸</h3>
    <div style="white-space:nowrap;">
      ğŸ° å…”å­ï¼š<span id="rabbitCount">0</span>
      ğŸ¢ çƒé¾œï¼š<span id="turtleCount">0</span>
      ğŸ’ çŒ´å­ï¼š<span id="monkeyCount">0</span>
    </div>
    <!-- ç©å®¶æ§åˆ¶å€å¡Šï¼ˆåªé¡¯ç¤ºé¸æ“‡çš„è§’è‰²ï¼‰ -->
    <div class="animal-container" id="playerControl" style="margin-top: 2rem;"></div>
  </div>
  <div id="winner"></div>

  <div id="verifyArea" style="display: none;margin-top: 2rem;">
    <input type="password" id="adminPass" placeholder="è¼¸å…¥ä¸»æŒäººå¯†ç¢¼" />
    <button onclick="verifyAdmin()">ç™»å…¥ä¸»æŒäºº</button>
  </div>

  <div id="resetSection" style="display: none; margin-top: 1rem;">
    <button id="startBtn" onclick="startGame()">ğŸ¬ é–‹å§‹éŠæˆ²</button>
    <button onclick="resetCounts()" style="background-color: #f44336;">ğŸ” é‡ç½®æ¯”è³½</button>
    <label style="margin-left:1rem;">
      <input type="checkbox" id="autoModeCheckbox" /> è‡ªå‹•æ¨¡å¼
    </label>
  </div>

  <!-- æ¨‚åœ’è‰åœ° -->
  <div class="grass"></div>
  <div class="grass-decoration">
    <!-- å°èŠ±èˆ‡å°æ¨¹éš¨æ©Ÿåˆ†å¸ƒï¼Œé¡è‰²/å¤§å°/æ—‹è½‰éš¨æ©Ÿ -->
    <div class="flower" style="left:7vw; bottom:14px; transform:rotate(-8deg) scale(1.1);"></div>
    <div class="flower flower2" style="left:13vw; bottom:22px; transform:rotate(12deg) scale(0.9); background:radial-gradient(circle,#fff176 60%,#4fc3f7 100%);"></div>
    <div class="flower" style="left:19vw; bottom:8px; transform:rotate(-18deg) scale(1.2); background:radial-gradient(circle,#fff176 60%,#aed581 100%);"></div>
    <div class="flower" style="left:27vw; bottom:18px; transform:rotate(7deg) scale(0.8); background:radial-gradient(circle,#fff176 60%,#f06292 100%);"></div>
    <div class="flower" style="left:36vw; bottom:12px; transform:rotate(-13deg) scale(1.15); background:radial-gradient(circle,#fff176 60%,#fbc02d 100%);"></div>
    <div class="flower" style="left:44vw; bottom:20px; transform:rotate(5deg) scale(1.05); background:radial-gradient(circle,#fff176 60%,#4fc3f7 100%);"></div>
    <div class="flower" style="left:53vw; bottom:10px; transform:rotate(-10deg) scale(0.95); background:radial-gradient(circle,#fff176 60%,#f06292 100%);"></div>
    <div class="flower" style="left:61vw; bottom:16px; transform:rotate(15deg) scale(1.18); background:radial-gradient(circle,#fff176 60%,#aed581 100%);"></div>
    <div class="flower" style="left:68vw; bottom:7px; transform:rotate(-6deg) scale(1.08); background:radial-gradient(circle,#fff176 60%,#fbc02d 100%);"></div>
    <div class="flower" style="left:76vw; bottom:19px; transform:rotate(9deg) scale(1.12); background:radial-gradient(circle,#fff176 60%,#f06292 100%);"></div>
    <div class="flower" style="left:83vw; bottom:11px; transform:rotate(-11deg) scale(0.92); background:radial-gradient(circle,#fff176 60%,#4fc3f7 100%);"></div>
    <div class="flower" style="left:91vw; bottom:23px; transform:rotate(17deg) scale(1.13); background:radial-gradient(circle,#fff176 60%,#aed581 100%);"></div>
    <!-- å°æ¨¹éš¨æ©Ÿåˆ†å¸ƒ -->
    <div class="tree" style="left:10vw; bottom:28px; transform:scale(1.1) rotate(-6deg);"></div>
    <div class="tree" style="left:18vw; bottom:18px; transform:scale(0.9) rotate(8deg);"></div>
    <div class="tree" style="left:25vw; bottom:24px; transform:scale(1.15) rotate(-12deg);"></div>
    <div class="tree" style="left:38vw; bottom:20px; transform:scale(1.05) rotate(5deg);"></div>
    <div class="tree" style="left:52vw; bottom:26px; transform:scale(0.95) rotate(-9deg);"></div>
    <div class="tree" style="left:63vw; bottom:16px; transform:scale(1.12) rotate(11deg);"></div>
    <div class="tree" style="left:71vw; bottom:22px; transform:scale(1.08) rotate(-7deg);"></div>
    <div class="tree" style="left:80vw; bottom:19px; transform:scale(1.18) rotate(13deg);"></div>
    <div class="tree" style="left:89vw; bottom:25px; transform:scale(1.03) rotate(-4deg);"></div>
  </div>
  <script type="module">
    // âœ… æ›¿æ›æˆä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBRLyJTY0TqEKtkQ0LAjF5BtenNHHUQ52k",
      authDomain: "animal-game-d7461.firebaseapp.com",
      projectId: "animal-game-d7461",
      storageBucket: "animal-game-d7461.firebasestorage.app",
      messagingSenderId: "857022080536",
      appId: "1:857022080536:web:69813a9bac56f0b386056d",
      measurementId: "G-29G94QDX9E"
    };


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const animals = ['rabbit', 'turtle', 'monkey'];
    let verifyAreaint = 0;
    animals.forEach(animal => {
      const countRef = ref(db, animal);
      onValue(countRef, (snapshot) => {
        document.getElementById(`${animal}Count`).textContent = snapshot.val() || 0;
      });
    });

    window.selectAnimal = function (animal) {
      const animalLockRef = ref(db, `selectedAnimals/${animal}`);
      set(animalLockRef, true); // é–å®šè§’è‰²

      document.getElementById("selectScreen").style.display = "none";
      document.getElementById("gameScreen").style.display = "block";
      requestSensorPermission(animal);
      const controlDiv = document.getElementById("playerControl");
      controlDiv.innerHTML = `
    <div id="${animal}" class="animal">${getAnimalEmoji(animal)}</div>
    <button class="clickAnimal" style="display: none;" onclick="clickAnimal('${animal}')">é» ${getAnimalName(animal)}</button> `;
    };


    // è¼”åŠ©å‡½å¼ï¼šå–å¾—å‹•ç‰© emoji
    function getAnimalEmoji(animal) {
      return {
        rabbit: "ğŸ°",
        turtle: "ğŸ¢",
        monkey: "ğŸ’"
      }[animal];
    }

    // è¼”åŠ©å‡½å¼ï¼šå–å¾—å‹•ç‰©ä¸­æ–‡åç¨±
    function getAnimalName(animal) {
      return {
        rabbit: "å…”å­",
        turtle: "çƒé¾œ",
        monkey: "çŒ´å­"
      }[animal];
    }
    // é–‹å§‹éŠæˆ²
    window.startGame = function () {
      update(ref(db), {
        "game/status": "running",
        "game/countdown": 10,
        "selectedAnimals/rabbit": false,
        "selectedAnimals/turtle": false,
        "selectedAnimals/monkey": false
      });

      let timeLeft = 10;
      const interval = setInterval(() => {
        timeLeft--;
        update(ref(db), { "game/countdown": timeLeft });
        if (timeLeft <= 0) {
          clearInterval(interval);
          update(ref(db), { "game/status": "ended" });
        }
      }, 1000);
    }

    // ç›£è½éŠæˆ²ç‹€æ…‹èˆ‡å€’æ•¸
    onValue(ref(db, "game"), (snapshot) => {
      const game = snapshot.val();
      const countdownEl = document.getElementById("countdown");
      if (!game) return;

      if (game.status === "running") {
        if (document.getElementsByClassName("clickAnimal").length > 0) document.getElementsByClassName("clickAnimal")[0].style.display = "block";
        countdownEl.innerText = `å€’æ•¸ï¼š${game.countdown} ç§’`;
      } else if (game.status === "ended") {
        countdownEl.innerText = "éŠæˆ²çµæŸï¼";
        if (document.getElementsByClassName("clickAnimal").length > 0) document.getElementsByClassName("clickAnimal")[0].remove();
        showWinner();
      } else {
        countdownEl.innerText = "ç­‰å¾…é–‹å§‹...";
        document.getElementById("winner").innerText = "";
        document.getElementById("selectScreen").style.display = "block";
        document.getElementById("gameScreen").style.display = "none";
      }
    });

    const selectedRef = ref(db, 'selectedAnimals');

    onValue(selectedRef, (snapshot) => {
      const selected = snapshot.val() || {};
      ['rabbit', 'turtle', 'monkey'].forEach(animal => {
        const btn = document.getElementById(`btn-${animal}`);
        if (btn) {
          if (selected[animal]) {
            btn.disabled = true;
            btn.textContent = `${getAnimalEmoji(animal)} ${getAnimalName(animal)}ï¼ˆå·²è¢«é¸æ“‡ï¼‰`;
          } else {
            btn.disabled = false;
            btn.textContent = `${getAnimalEmoji(animal)} ${getAnimalName(animal)}`;
          }
        }
      });
      checkAutoStart();
    });

    let autoMode = false;
    const modeRef = ref(db, 'mode');
    onValue(modeRef, (snapshot) => {
      autoMode = !!snapshot.val();
    });

    function checkAutoStart() {
      if (!autoMode) return;
      onValue(selectedRef, (snapshot) => {
        const selected = snapshot.val() || {};
        const allSelected = animals.every(animal => selected[animal]);
        if (allSelected) {
          document.getElementById("selectScreen").style.display = "none";
          document.getElementById("gameScreen").style.display = "block";
          let countdown = 3;
          document.getElementById("countdown").innerText = `éŠæˆ²å³å°‡é–‹å§‹ï¼š${countdown} ç§’`;
          const preStart = setInterval(() => {
            countdown--;
            document.getElementById("countdown").innerText = `éŠæˆ²å³å°‡é–‹å§‹ï¼š${countdown} ç§’`;
            if (countdown <= 0) {
              clearInterval(preStart);
              autoStartGame();
            }
          }, 1000);
        }
      });
    }

    function autoStartGame() {
      update(ref(db), {
        "game/status": "running",
        "game/countdown": 10,
        "selectedAnimals/rabbit": true,
        "selectedAnimals/turtle": true,
        "selectedAnimals/monkey": true
      });
      let timeLeft = 10;
      const interval = setInterval(() => {
        timeLeft--;
        update(ref(db), { "game/countdown": timeLeft });
        if (timeLeft <= 0) {
          clearInterval(interval);
          update(ref(db), { "game/status": "ended" });
          setTimeout(() => {
            showWinner();
            autoResetToSelect();
          }, 1000);
        }
      }, 1000);
    }

    function autoResetToSelect() {
      let countdown = 3;
      document.getElementById("countdown").innerText = `å³å°‡å›åˆ°é¸æ“‡ç•«é¢ï¼š${countdown} ç§’`;
      const resetTimer = setInterval(() => {
        countdown--;
        document.getElementById("countdown").innerText = `å³å°‡å›åˆ°é¸æ“‡ç•«é¢ï¼š${countdown} ç§’`;
        if (countdown <= 0) {
          clearInterval(resetTimer);
          animals.forEach(animal => {
            set(ref(db, animal), 0);
            set(ref(db, `selectedAnimals/${animal}`), false);
          });
          update(ref(db), {
            "game/status": "waiting",
            "game/countdown": 10,
            "selectedAnimals/rabbit": false,
            "selectedAnimals/turtle": false,
            "selectedAnimals/monkey": false
          });
          document.getElementById("winner").innerText = "";
          document.getElementById("selectScreen").style.display = "block";
          document.getElementById("gameScreen").style.display = "none";
          document.getElementById("countdown").innerText = "ç­‰å¾…é–‹å§‹...";
        }
      }, 1000);
    }

    // é¡¯ç¤ºç²å‹è€…
    function showWinner() {
      let MaxCount = 0;
      let winner = "";
      animals.forEach(animal => {
        const countRef = ref(db, animal);
        onValue(countRef, (snapshot) => {
          if (parseInt(snapshot.val()) > MaxCount) {
            MaxCount = snapshot.val();
            winner = animal;
          }else if(parseInt(snapshot.val()) >= 1 && snapshot.val() == MaxCount){
            winner += `, ${animal}`;
          }
        });
      });
      if(winner == "") winner = "ğŸ˜‚ æ²’äººç²å‹";
      document.getElementById("winner").innerText = `ğŸ‰ ç²å‹çš„æ˜¯ï¼š${winner}`;
    }

    // ğŸ“± æ‰‹æ©Ÿæ–æ™ƒåµæ¸¬
    function PhoneShake(animal) {
      return function (event) {
        let lastShakeTime = 0;
        const shakeThreshold = 15; // åŠ é€Ÿåº¦é–¾å€¼
        const shakeCooldown = 1000; // æ¯æ¬¡æ–æ™ƒé–“éš”ï¼ˆæ¯«ç§’ï¼‰
        const acc = event.accelerationIncludingGravity;
        const accTotal = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);

        const now = Date.now();
        if (accTotal > shakeThreshold && now - lastShakeTime > shakeCooldown) {
          const ca = document.getElementsByClassName("clickAnimal");
          if (ca.length > 0 && ca[0].style.display != "none") {
            clickAnimal(animal);
            lastShakeTime = now;
          }
        }
      };
    }

    let currentShakeHandler = null;

    function requestSensorPermission(animal) {
      if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(state => {
          if (state === 'granted') {
            if (currentShakeHandler) {
              window.removeEventListener('devicemotion', currentShakeHandler);
            }
            currentShakeHandler = PhoneShake(animal);
            window.addEventListener('devicemotion', currentShakeHandler);
          } else {
            alert('è«‹å…è¨±ä½¿ç”¨æ„Ÿæ‡‰å™¨æ¬Šé™');
          }
        }).catch(err => {
          alert('æˆæ¬Šå¤±æ•—ï¼š', err);
          console.error('æˆæ¬Šå¤±æ•—ï¼š', err);
        });
      } else {
        // é iOS æˆ–å·²æ”¯æ´ç€è¦½å™¨
        if (currentShakeHandler) {
          window.removeEventListener('devicemotion', currentShakeHandler);
        }
        currentShakeHandler = PhoneShake(animal);
        window.addEventListener('devicemotion', currentShakeHandler);
      }
    }

    window.clickAnimal = function (animal) {
      const countRef = ref(db, animal);
      onValue(countRef, (snapshot) => {
        const current = snapshot.val() || 0;
        set(countRef, current + 1);
      }, { onlyOnce: true });

      const el = document.getElementById(animal);
      el.classList.add('bounce');
      setTimeout(() => el.classList.remove('bounce'), 200);
    };

    const adminPassword = "lee"; // ğŸ”‘ ä½ å¯ä»¥æ”¹æˆä½ æƒ³è¦çš„å¯†ç¢¼

    window.verifyAdmin = function () {
      const input = document.getElementById("adminPass").value;
      if (input === adminPassword) {
        document.getElementById("resetSection").style.display = "block";
        document.getElementById("adminPass").value = "";
        alert("âœ… ä¸»æŒäººç™»å…¥æˆåŠŸï¼");
      } else {
        alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");
      }
    };

    window.verifyArea = function () {
      verifyAreaint += 1;
      if (verifyAreaint >= 3) {
        document.getElementById("verifyArea").style.display = "block";
        verifyAreaint = 0;
      }
    }

    window.resetCounts = function () {
      animals.forEach(animal => {
        const countRef = ref(db, animal);
        set(countRef, 0);
        // const animalLockRef = ref(db, `selectedAnimals/${animal}`);
        // set(animalLockRef, false); // é–å®šè§’è‰²

      });
      update(ref(db), {
        "game/status": "waiting",
        "game/countdown": 10,
        "selectedAnimals/rabbit": false,
        "selectedAnimals/turtle": false,
        "selectedAnimals/monkey": false
      });
      document.getElementById("resetSection").style.display = "none";
      document.getElementById("verifyArea").style.display = "none";

      alert("ğŸ‰ æ‰€æœ‰é»æ“Šæ¬¡æ•¸å·²é‡ç½®ï¼");
    };

    // Checkbox è®€å–èˆ‡æ›´æ–° mode åƒæ•¸
    function updateAutoModeCheckbox() {
      const checkbox = document.getElementById('autoModeCheckbox');
      if (!checkbox) return;
      checkbox.checked = autoMode;
      checkbox.onchange = function() {
        set(ref(db, 'mode'), checkbox.checked);
      };
    }

    // ç•¶ resetSection é¡¯ç¤ºæ™‚ï¼Œæ›´æ–° Checkbox ç‹€æ…‹
    const resetSectionObserver = new MutationObserver(() => {
      const resetSection = document.getElementById('resetSection');
      if (resetSection && resetSection.style.display !== 'none') {
        updateAutoModeCheckbox();
      }
    });
    resetSectionObserver.observe(document.body, { childList: true, subtree: true });

    // mode åƒæ•¸è®Šå‹•æ™‚åŒæ­¥ Checkbox ä¸¦èª¿æ•´æµç¨‹
    onValue(modeRef, (snapshot) => {
      autoMode = !!snapshot.val();
      updateAutoModeCheckbox();
      if (autoMode) {
        // è‡ªå‹•æ¨¡å¼ï¼šéš±è—ä¸»æŒäººç›¸é—œå€å¡Š
        document.getElementById("resetSection").style.display = "none";
        document.getElementById("verifyArea").style.display = "none";
        // è‹¥ä¸‰å€‹å‹•ç‰©å·²é¸ï¼Œç›´æ¥é€²å…¥è‡ªå‹•æµç¨‹
        checkAutoStart();
      } else {
        // æ‰‹å‹•æ¨¡å¼ï¼šé¡¯ç¤ºä¸»æŒäººç™»å…¥å€å¡Š
        document.getElementById("resetSection").style.display = "none";
        document.getElementById("verifyArea").style.display = "none";
        // å›åˆ°åˆå§‹ç•«é¢
        document.getElementById("selectScreen").style.display = "block";
        document.getElementById("gameScreen").style.display = "none";
        document.getElementById("winner").innerText = "";
        document.getElementById("countdown").innerText = "ç­‰å¾…é–‹å§‹...";
        // é‡è¨­æ‰€æœ‰é¸æ“‡
        animals.forEach(animal => {
          set(ref(db, animal), 0);
          set(ref(db, `selectedAnimals/${animal}`), false);
        });
        update(ref(db), {
          "game/status": "waiting",
          "game/countdown": 10,
          "selectedAnimals/rabbit": false,
          "selectedAnimals/turtle": false,
          "selectedAnimals/monkey": false
        });
      }
    });

  </script>
</body>

</html>