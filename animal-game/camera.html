<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>手機拍照合成</title>
  <style>
    body { font-family: Segoe UI, sans-serif; background: #f0f8ff; text-align: center; margin: 0; padding: 1rem; }
    #cameraWrap { position: relative; display: inline-block; }
    #video { width: 90vw; max-width: 480px; height: auto; border-radius: 12px; }
    #overlayImg { position: absolute; right: 6px; bottom: 6px; left: auto; top: auto; width: auto; height: 240px; pointer-events: none; }
    #canvas { display: none; margin-top: 1rem; border-radius: 12px; max-width:480px; max-height:480px; }
    #btns { margin-top: 1.5rem; }
    button { padding: 0.7rem 1.5rem; font-size: 1.1rem; border-radius: 8px; border: none; background: #4caf50; color: #fff; margin: 0.5rem; cursor: pointer; }
    button:hover { background: #388e3c; }
  </style>
</head>
<body>
  <h2>手機拍照合成</h2>
  <div id="cameraWrap" style="position:relative;">
    <video id="video" autoplay playsinline style="cursor:pointer;"></video>
    <img id="overlayImg" src="overlay.png" alt="overlay" style="cursor:pointer;" />
    <div id="cameraTip" style="position:absolute;left:0;right:0;bottom:12px;color:#388e3c;font-size:1.2rem;background:rgba(255,255,255,0.7);padding:0.5rem 0;border-radius:8px;">點擊畫面可拍照</div>
  </div>
  <canvas id="canvas" width="400" height="400"></canvas>
  <div id="resultBtns" style="display:none;"></div>
  <script>
    const video = document.getElementById('video');
    const overlayImg = document.getElementById('overlayImg');
    const canvas = document.getElementById('canvas');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const btns = document.getElementById('btns');
    const resultBtns = document.getElementById('resultBtns');
    const downloadBtn = document.getElementById('downloadBtn');
    const backBtn = document.getElementById('backBtn');
    const cameraTip = document.getElementById('cameraTip');

    // 點擊即時影像或懸浮圖片也能拍照
function doTakePhoto() {
  // 以 video 寬高為主，canvas 跟 video 同比例
  cameraTip.style.display = 'none';
  const vw = video.videoWidth || 480;
  const vh = video.videoHeight || 360;
  canvas.width = vw;
  canvas.height = vh;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, vw, vh);
  // 取得 overlayImg 在 video 上的實際顯示尺寸與位置
  const videoRect = video.getBoundingClientRect();
  const overlayRect = overlayImg.getBoundingClientRect();
  // 計算 overlay 在 canvas 上的座標與尺寸
  const scaleX = vw / videoRect.width;
  const scaleY = vh / videoRect.height;
  const ow = overlayRect.width * scaleX;
  const oh = overlayRect.height * scaleY;
  const ox = (overlayRect.left - videoRect.left) * scaleX;
  const oy = (overlayRect.top - videoRect.top) * scaleY;
  const imgObj = new Image();
  imgObj.src = overlayImg.src;
  imgObj.onload = function() {
    ctx.drawImage(imgObj, ox, oy, ow, oh);
    // 產生 base64 圖片
    const url = canvas.toDataURL('image/png');
    let resultImg = document.getElementById('resultImg');
    if (!resultImg) {
      resultImg = document.createElement('img');
      resultImg.id = 'resultImg';
      resultImg.style = 'width:90vw;max-width:480px;border-radius:12px;margin-top:1.5rem;display:block;object-fit:contain;opacity:0;transform:translateY(-40px);transition:all 0.6s cubic-bezier(.4,2,.3,1);';
      resultImg.alt = '合成圖片';
      // 顯示在 resultBtns 區塊下方
      if (resultBtns.nextSibling) {
        resultBtns.parentNode.insertBefore(resultImg, resultBtns.nextSibling);
      } else {
        resultBtns.parentNode.appendChild(resultImg);
      }
    }
    // 每次拍照都覆蓋圖片
    resultImg.src = url;
    resultImg.style.display = 'block';
    resultImg.style.opacity = '0';
    resultImg.style.transform = 'translateY(-40px)';
    setTimeout(() => {
      resultImg.style.opacity = '1';
      resultImg.style.transform = 'translateY(0)';
      // 平滑滾動到 resultImg
      resultImg.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 50);
    canvas.style.display = 'none';
    resultBtns.style.display = 'block';
    // 顯示提示
    let tip = document.getElementById('saveTip');
    if (!tip) {
      tip = document.createElement('div');
      tip.id = 'saveTip';
      tip.innerText = '長按圖片可儲存到相簿';
      tip.style = 'color:#388e3c;font-size:1.1rem;margin:0.5rem 0;';
      resultImg.parentNode.insertBefore(tip, resultImg.nextSibling);
    } else {
      tip.style.display = 'block';
    }
  };
}
video.onclick = doTakePhoto;
overlayImg.onclick = doTakePhoto;

    // 啟動相機
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        alert('無法開啟相機：' + err);
      }
    }
    startCamera();

    // 拍照合成
    takePhotoBtn.onclick = function() {
      doTakePhoto();
    };

    // 下載圖片
    downloadBtn.onclick = function() {
      // 下載 resultImg 的圖片
      const resultImg = document.getElementById('resultImg');
      if (resultImg && resultImg.src) {
        const a = document.createElement('a');
        a.href = resultImg.src;
        a.download = 'photo.png';
        a.click();
        setTimeout(() => {
          alert('圖片已下載，請到手機下載資料夾或相簿查看');
        }, 500);
      }
    };
    // 回主畫面
    backBtn.onclick = function() {
      // 已移除主畫面功能，這裡不做任何事
    };
  </script>
</body>
</html>
