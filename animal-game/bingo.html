<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>Bingo Battle Pro v2</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            text-align: center;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(5, 60px);
            gap: 5px;
            justify-content: center;
            margin-top: 20px;
        }

        .cell {
            width: 60px;
            height: 60px;
            background: #eee;
            border: 1px solid #999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .won {
            background: gold;
            color: black;
        }
    </style>
</head>

<body>

    <h2>üî• Bingo Battle Pro v2</h2>
    <button onclick="login()">ÂåøÂêçÁôªÂÖ•</button>
    <div id="playerInfo"></div>

    <input type="text" id="roomInput" placeholder="ÊàøÈñì‰ª£Á¢ºÔºàÂèØËº∏ÂÖ•‰ªªÊÑè‰ª£Á¢ºÔºâ" />
    <select id="playerSelect">
        <option value="playerA">Player A</option>
        <option value="playerB">Player B</option>
    </select>

    <div class="board" id="board"></div>
    <h3 id="scoreDisplay"></h3>

    <script>
        // üîß Firebase Ë®≠ÂÆöÔºàË´ãÊõøÊèõÊàê‰Ω†ÁöÑÂ∞àÊ°àË®≠ÂÆöÔºâ
        const firebaseConfig = {
            apiKey: "AIzaSyDfVYrZ07ZWwV_uYnbUFflU8iik93grvns",
            authDomain: "bingogame-8bb16.firebaseapp.com",
            projectId: "bingogame-8bb16",
            storageBucket: "bingogame-8bb16.firebasestorage.app",
            messagingSenderId: "913984914435",
            appId: "1:913984914435:web:b26b5c396b54f20bfaba36",
            measurementId: "G-HLMC4VXT5V"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let uid = "";
        let name = "";

        let È°åÂ∫´ = [
            "Âè∞ÁÅ£ÁöÑÈ¶ñÈÉΩÊòØÔºü", "Â§™ÈôΩÂæûÂì™Ë£°ÂçáËµ∑Ôºü", "3 √ó 4 = ?", "ÂúãÊÖ∂Êó•Ôºü", "Á¥ÖËâ≤Ê∞¥ÊûúÔºü",
            "Ê∞¥ÁöÑÊ≤∏ÈªûÔºü", "Âè∞ÁÅ£ÊúÄÈ´òÂ±±Ôºü", "‰Ω† ÁöÑËã±ÊñáÔºü", "Êò•Â§©ÊòØÂì™‰∫õÊúàÔºü", "Âè∞ÁÅ£Áî®‰ªÄÈ∫ºË≤®Âπ£Ôºü",
            "Âú∞ÁêÉÁöÑË°õÊòüÔºü", "FacebookÂâµËæ¶‰∫∫Ôºü", "ÊúÄÈ´òÂ±±Ôºü", "2 ÁöÑ‰∫åÈÄ≤‰ΩçÔºü", "Êó•ÊñáË≤®Âπ£Ôºü",
            "CSS ÊòØ‰ªÄÈ∫ºÁ∏ÆÂØ´Ôºü", "CPU ÂÖ®ÂêçÔºü", "React ÊòØ‰ªÄÈ∫ºÔºü", "Pi Á¥ÑÁ≠âÊñºÔºü", "ÊúÄÂ§öÂúãÂÆ∂Ê¥≤Ôºü",
            "Â§ßË±°ÊòØÈô∏‰∏äÊúÄÂ§ßÔºü", "ÁÅ´ÊòüÂà•ÂêçÔºü", "Âú∞ÁêÉÁ¨¨3Ë°åÊòüÔºü", "HTML ÊòØ‰ªÄÈ∫ºÔºü", "Ê∞¥ÁöÑÂåñÂ≠∏ÂºèÔºü"
        ];
        let Á≠îÊ°àÂ∫´ = [
            "Âè∞Âåó", "Êù±Êñπ", "12", "10Êúà10Êó•", "ËòãÊûú",
            "100", "ÁéâÂ±±", "you", "3Âà∞5Êúà", "Êñ∞Âè∞Âπ£",
            "Êúà‰∫Æ", "Mark Zuckerberg", "ÁéâÂ±±", "10", "Êó•Âúì",
            "Cascading Style Sheets", "Central Processing Unit", "JavaScript Library", "3.14", "ÈùûÊ¥≤",
            "ÊòØ", "Á¥ÖËâ≤ÊòüÁêÉ", "Âú∞ÁêÉ", "HyperText Markup Language", "H2O"
        ];

        const boardEl = document.getElementById("board");
        const roomInput = document.getElementById("roomInput");
        const playerSelect = document.getElementById("playerSelect");
        const scoreDisplay = document.getElementById("scoreDisplay");

        const login = () => {
            auth.signInAnonymously()
                .then(result => {
                    uid = result.user.uid;
                    name = "Guest";
                    document.getElementById("playerInfo").textContent = `üë§ Â∑≤ÁôªÂÖ•Ôºö${name}`;
                });
        };

        function shuffleÈ°åÂ∫´ËàáÁ≠îÊ°à(È°åÂ∫´, Á≠îÊ°àÂ∫´) {
            let combined = È°åÂ∫´.map((q, i) => ({ question: q, answer: Á≠îÊ°àÂ∫´[i] }));
            for (let i = combined.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [combined[i], combined[j]] = [combined[j], combined[i]];
            }
            // ÊãÜÂõû‰æÜ
            const shuffledÈ°åÂ∫´ = combined.map(item => item.question);
            const shuffledÁ≠îÊ°àÂ∫´ = combined.map(item => item.answer);
            return { shuffledÈ°åÂ∫´, shuffledÁ≠îÊ°àÂ∫´ };
        }

        let { shuffledÈ°åÂ∫´, shuffledÁ≠îÊ°àÂ∫´ } = shuffleÈ°åÂ∫´ËàáÁ≠îÊ°à(È°åÂ∫´, Á≠îÊ°àÂ∫´);
        È°åÂ∫´ = shuffledÈ°åÂ∫´;
        Á≠îÊ°àÂ∫´ = shuffledÁ≠îÊ°àÂ∫´;

        const drawBoard = () => {
            boardEl.innerHTML = "";
            È°åÂ∫´.forEach((_, i) => {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.textContent = "‚ùì";
                cell.id = `cell-${i}`;
                cell.onclick = () => showQuestion(i);
                boardEl.appendChild(cell);
            });
        };



        const showQuestion = (i) => {
            const answer = prompt(`üìã È°åÁõÆÔºö${È°åÂ∫´[i]}`);
            if (!answer) return;
            const correct = Á≠îÊ°àÂ∫´[i].toLowerCase().trim();
            const room = roomInput.value || "defaultRoom";
            const player = playerSelect.value;
            const answerRef = db.ref(`game/${room}/answers/${i}`);

            if (answer.toLowerCase().trim() === correct) {
                answerRef.transaction(current => {
                    if (!current) return { answeredBy: player };
                     alert(`‚ùó Ê≠§È°åÂ∑≤Ë¢´ ${player} Á≠îÂ∞ç`);
                    return; // Â∑≤Êúâ‰∫∫Á≠îÈÅé
                });
            } else {
                alert("‚ùå ÈåØË™§Á≠îÊ°àÔºÅ");
            }
        };

        const listenUpdates = () => {
            const room = roomInput.value || "defaultRoom";
            scoreDisplay.innerHTML = "";

            db.ref(`game/${room}/answers`).on("value", snapshot => {
                const data = snapshot.val() || {};
                Object.entries(data).forEach(([i, obj]) => {
                    const cell = document.getElementById(`cell-${i}`);
                    if (!cell) return;
                    if (obj.answeredBy === "playerA") {
                        cell.style.background = "#4caf50";
                        cell.textContent = "A";
                    } else if (obj.answeredBy === "playerB") {
                        cell.style.background = "#2196f3";
                        cell.textContent = "B";
                    }
                });

                ["playerA", "playerB"].forEach(player => {
                    const cells = Object.entries(data).filter(([_, obj]) => obj.answeredBy === player).map(([i]) => parseInt(i));
                    checkWin(cells, room, player);
                });
            });

            // ["playerA", "playerB"].forEach(player => {
            //     db.ref(`score/${room}/${player}`).on("value", snap => {
            //         const score = snap.val() || 0;
            //         const label = document.createElement("div");
            //         label.textContent = `${player}: ${score} ÂàÜ`;
            //         scoreDisplay.appendChild(label);
            //     });
            // });
        };

        const checkWin = (clicked, room, player) => {
            const lines = [
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];
            lines.forEach(line => {
                if (line.every(x => clicked.includes(x))) {
                    line.forEach(c => {
                        const cell = document.getElementById(`cell-${c}`);
                        if (cell) cell.classList.add("won");
                    });
                    alert(`üéâ ${player} Ë¥è‰∫ÜÔºÅ`);
                    db.ref(`score/${room}/${player}`).transaction(s => (s || 0) + 10);
                }
            });
        };

        drawBoard();
        roomInput.onchange = listenUpdates;
        playerSelect.onchange = listenUpdates;
    </script>

</body>

</html>