<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機拍照合成3</title>
    <style>
        body { font-family: Segoe UI, sans-serif; background: #f0f8ff; text-align: center; margin: 0; padding: 1rem; }
        #cameraWrap { position: relative; display: inline-block; }
        #video { width: 90vw; max-width: 400px; border-radius: 12px; }
        #overlayImg { position: absolute; right: 10px; bottom: 10px; width: auto; height: 240px; pointer-events: none; display:none; }
        #canvas { display: none; margin-top: 1rem; border-radius: 12px; }
        #btns { margin-top: 1.5rem; }
        button { padding: 0.7rem 1.5rem; font-size: 1.1rem; border-radius: 8px; border: none; background: #4caf50; color: #fff; margin: 0.5rem; cursor: pointer; }
        button:hover { background: #388e3c; }
  </style>
</head>
<body>
    <!-- index.html -->
<button id="takePhotoBtn">拍照</button>
<img id="previewImg" style="display:none;"/>
<img id="overlayImg" src="overlay.png" style="display:none;"/>
<canvas id="canvas" style="display:none;"></canvas>
<button id="downloadBtn" style="display:none;">下載圖片</button>
<button id="backBtn" style="display:none;">回主畫面</button>
<script>
document.addEventListener('deviceready', function() {
  const takePhotoBtn = document.getElementById('takePhotoBtn');
  const previewImg = document.getElementById('previewImg');
  const overlayImg = document.getElementById('overlayImg');
  const canvas = document.getElementById('canvas');
  const downloadBtn = document.getElementById('downloadBtn');
  const backBtn = document.getElementById('backBtn');

  takePhotoBtn.onclick = function() {
    navigator.camera.getPicture(function(imageData) {
      previewImg.src = "data:image/jpeg;base64," + imageData;
      previewImg.style.display = 'block';
      overlayImg.style.display = 'block';
      setTimeout(mergePhoto, 500);
    }, function(msg) {
      alert('拍照失敗: ' + msg);
    }, {
      quality: 80,
      destinationType: Camera.DestinationType.DATA_URL,
      targetWidth: 400,
      targetHeight: 400
    });
  };

  function mergePhoto() {
    const vw = previewImg.naturalWidth || 400;
    const vh = previewImg.naturalHeight || 400;
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(previewImg, 0, 0, vw, vh);
    const img = new Image();
    img.src = overlayImg.src;
    img.onload = function() {
      ctx.drawImage(img, vw-120, vh-120, 120, 120); // 可調整位置與大小
      canvas.style.display = 'block';
      downloadBtn.style.display = 'block';
      backBtn.style.display = 'block';
      previewImg.style.display = 'none';
      overlayImg.style.display = 'none';
    };
  }

  downloadBtn.onclick = function() {
    const dataUrl = canvas.toDataURL('image/png');
    // Cordova 可用 cordova-plugin-file 寫入本地或 cordova-plugin-photo-library 儲存到相簿
    window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory, function(dir) {
      dir.getFile("photo.png", {create:true}, function(file) {
        file.createWriter(function(writer) {
          writer.write(dataUrl);
          alert('已儲存到手機');
        });
      });
    });
  };

  backBtn.onclick = function() {
    canvas.style.display = 'none';
    downloadBtn.style.display = 'none';
    backBtn.style.display = 'none';
    takePhotoBtn.style.display = 'block';
  };
});
</script>
</body>
</html>