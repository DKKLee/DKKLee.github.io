<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å³æ™‚æŠ½çåå–®</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f0f8ff; text-align: center; margin: 0; padding: 2rem; }
    h1 { color: #333; cursor: pointer; }
    .input-group { margin: 1rem 0; }
    input { padding: 0.5rem; font-size: 1rem; margin: 0.3rem; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; border: none; border-radius: 8px; background-color: #4caf50; color: white; cursor: pointer; margin: 0.5rem; }
    button:hover { background-color: #45a049; }
    #lotteryPanel { display: flex; justify-content: center; gap: 2rem; margin-top: 2rem; }
    #userList, #winnerList { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 1rem; min-width: 220px; }
    #winnerList { min-width: 220px; }
    .winner { color: #d2691e; font-weight: bold; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h1 id="mainTitle">ğŸ å³æ™‚æŠ½çåå–® ğŸ</h1>
  <div id="inputPanel">
    <div class="input-group">
      <input type="text" id="nameInput" placeholder="å§“å" />
      <input type="text" id="phoneInput" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" />
      <button onclick="submitUser()">é€å‡º</button>
    </div>
    <div id="submitMsg"></div>
  </div>

  <div id="lotteryPanel" style="display:none;">
    <div id="userList">
      <h3>æ‰€æœ‰åå–®</h3>
      <ul id="userUl"></ul>
      <button onclick="clearAllUsers()" style="background-color:#f44336; margin-top:1rem;">æ¸…é™¤æ‰€æœ‰åå–®</button>
    </div>
    <div>
      <button id="drawBtn" onclick="drawWinner()">æŠ½ç</button>
      <canvas id="wheelCanvas" width="300" height="300" style="display:none;margin-top:1rem;"></canvas>
    </div>
    <div id="winnerList">
      <h3>ä¸­çè€…</h3>
      <div id="winnerDiv"></div>
      <button onclick="clearWinners()" style="background-color:#f44336; margin-top:1rem;">æ¸…é™¤ä¸­çåå–®</button>
    </div>
  </div>

  <div id="adminPanel" style="display:none; margin-top:2rem;">
    <input type="password" id="adminPass" placeholder="è¼¸å…¥å¾Œå°å¯†ç¢¼" />
    <button onclick="verifyAdmin()">é€²å¾Œå°</button>
    <div id="adminMsg" style="color:#d2691e;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, update, remove } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRLyJTY0TqEKtkQ0LAjF5BtenNHHUQ52k",
      authDomain: "animal-game-d7461.firebaseapp.com",
      projectId: "animal-game-d7461",
      storageBucket: "animal-game-d7461.firebasestorage.app",
      messagingSenderId: "857022080536",
      appId: "1:857022080536:web:69813a9bac56f0b386056d",
      measurementId: "G-29G94QDX9E"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // å‰å°é€å‡ºè³‡æ–™
    window.submitUser = function() {
      const name = document.getElementById('nameInput').value.trim();
      const phone = document.getElementById('phoneInput').value.trim();
      if (!name || !phone) {
        document.getElementById('submitMsg').innerText = 'è«‹å¡«å¯«å®Œæ•´è³‡æ–™';
        return;
      }
      const userRef = push(ref(db, 'lottery/users'));
      set(userRef, { name, phone });
      document.getElementById('submitMsg').innerText = 'å·²é€å‡ºï¼';
      document.getElementById('nameInput').value = '';
      document.getElementById('phoneInput').value = '';
    };

    // ç›£è½æ‰€æœ‰åå–®
    let users = {};
    onValue(ref(db, 'lottery/users'), (snapshot) => {
      users = snapshot.val() || {};
      renderUserList();
    });

    // ç›£è½æ‰€æœ‰ä¸­çè€…
    let winners = [];
    onValue(ref(db, 'lottery/winners'), (snapshot) => {
      winners = snapshot.val() || [];
      renderWinnerList();
    });

    function renderUserList() {
      const ul = document.getElementById('userUl');
      ul.innerHTML = '';
      Object.entries(users).forEach(([key, user]) => {
        ul.innerHTML += `<li>${user.name} (${user.phone})</li>`;
      });
    }
    function renderWinnerList() {
      const div = document.getElementById('winnerDiv');
      div.innerHTML = '';
      winners.forEach(w => {
        div.innerHTML += `<div class='winner'>${w.name} (${w.phone})</div>`;
      });
    }

    // æ¸…é™¤æ‰€æœ‰åå–®
    window.clearAllUsers = function() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åå–®èˆ‡ä¸­çè€…ï¼Ÿ')) {
        set(ref(db, 'lottery/users'), null);
        set(ref(db, 'lottery/winners'), null);
      }
    };

    // æ¸…é™¤ä¸­çåå–®
    window.clearWinners = function() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ä¸­çåå–®ï¼Ÿ')) {
        set(ref(db, 'lottery/winners'), null);
      }
    };

    // è½‰ç›¤å‹•ç•«
    function drawWheel(names, highlightIdx = null) {
      const canvas = document.getElementById('wheelCanvas');
      const ctx = canvas.getContext('2d');
      const size = names.length;
      const angle = 2 * Math.PI / size;
      ctx.clearRect(0, 0, 300, 300);
      for (let i = 0; i < size; i++) {
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 140, angle * i, angle * (i + 1));
        ctx.closePath();
        ctx.fillStyle = (highlightIdx === i) ? '#ffd700' : (i % 2 === 0 ? '#ffe4b5' : '#b0e0e6');
        ctx.fill();
        ctx.save();
        ctx.translate(150, 150);
        ctx.rotate(angle * (i + 0.5));
        ctx.textAlign = 'center';
        ctx.fillStyle = '#333';
        ctx.font = '16px Segoe UI';
        ctx.fillText(names[i], 90, 0);
        ctx.restore();
      }
      // ç•«ç®­é ­
      ctx.save();
      ctx.translate(150, 150);
      ctx.rotate(-Math.PI/2);
      ctx.beginPath();
      ctx.moveTo(0, -120);
      ctx.lineTo(-15, -90);
      ctx.lineTo(15, -90);
      ctx.closePath();
      ctx.fillStyle = '#d2691e';
      ctx.fill();
      ctx.restore();
    }

    // æŠ½çé‚è¼¯ï¼ˆå‹•ç•«å„ªåŒ–ç‰ˆï¼‰
    window.drawWinner = function() {
      const drawBtn = document.getElementById('drawBtn');
      const canvas = document.getElementById('wheelCanvas');
      const winnerPhones = winners.map(w => w.phone);
      const candidates = Object.entries(users).filter(([key, user]) => !winnerPhones.includes(user.phone));
      if (candidates.length === 0) {
        alert('æ²’æœ‰å¯æŠ½çš„äººäº†ï¼');
        return;
      }
      const names = candidates.map(([key, user]) => user.name);
      const winnerIdx = Math.floor(Math.random() * candidates.length);
      canvas.style.display = 'block';
      drawBtn.disabled = true;
      let totalTime = 300; // 300mså¿«é€Ÿæ—‹è½‰
      let start = null;
      let currentAngle = 0;
      let frameId;
      function fastSpin(ts) {
        if (!start) start = ts;
        let elapsed = ts - start;
        currentAngle = (elapsed / totalTime) * 10 * 2 * Math.PI; // 10åœˆ
        drawWheel(names);
        // æ—‹è½‰canvas
        canvas.style.transform = `rotate(${currentAngle}rad)`;
        if (elapsed < totalTime) {
          frameId = requestAnimationFrame(fastSpin);
        } else {
          // åœæ­¢ï¼Œç®­é ­æŒ‡å‘ä¸­çè€…
          canvas.style.transform = `rotate(${-(winnerIdx * (2 * Math.PI / names.length))})`;
          drawWheel(names, winnerIdx);
          setTimeout(() => {
            const [key, user] = candidates[winnerIdx];
            winners.push(user);
            set(ref(db, 'lottery/winners'), winners);
            canvas.style.display = 'none';
            canvas.style.transform = '';
            drawBtn.disabled = false;
          }, 1200);
        }
      }
      requestAnimationFrame(fastSpin);
    };

    const adminPassword = "lee"; // ä½ å¯ä»¥è‡ªè¨‚å¯†ç¢¼

    window.verifyAdmin = function() {
      const input = document.getElementById("adminPass").value;
      if (input === adminPassword) {
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("lotteryPanel").style.display = "flex";
        document.getElementById("adminPass").value = "";
        document.getElementById("adminMsg").innerText = "";
      } else {
        document.getElementById("adminMsg").innerText = "å¯†ç¢¼éŒ¯èª¤ï¼";
      }
    };

    // æ¨™é¡Œé»ä¸‰ä¸‹åˆ‡æ›å¾Œå°ï¼ˆåŠ å¯†ç¢¼é©—è­‰ï¼‰
    let titleClickCount = 0;
    document.getElementById('mainTitle').onclick = function() {
      titleClickCount++;
      if (titleClickCount >= 3) {
        document.getElementById('inputPanel').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('lotteryPanel').style.display = 'none';
        titleClickCount = 0;
      }
    };
  </script>
</body>
</html>
